<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acemcp Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-100">
    <div x-data="mcpManager()" x-init="init()" class="container mx-auto p-6">
        <header class="bg-white shadow rounded-lg p-6 mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800" x-text="t('title')"></h1>
                <p class="text-gray-600 mt-2" x-text="t('subtitle')"></p>
            </div>
            <div class="flex gap-2">
                <button @click="setLanguage('en')" :class="lang === 'en' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'" class="px-3 py-1 rounded text-sm">
                    English
                </button>
                <button @click="setLanguage('zh')" :class="lang === 'zh' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'" class="px-3 py-1 rounded text-sm">
                    中文
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-2" x-text="t('status')"></h3>
                <p class="text-2xl font-bold" :class="status.status === 'running' ? 'text-green-600' : 'text-red-600'" x-text="t('status_' + status.status)"></p>
            </div>
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-2" x-text="t('indexed_projects')"></h3>
                <p class="text-2xl font-bold text-blue-600" x-text="status.project_count"></p>
            </div>
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-2" x-text="t('storage_path')"></h3>
                <p class="text-sm text-gray-600 truncate" x-text="status.storage_path"></p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white shadow rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800" x-text="t('configuration')"></h2>
                    <button @click="editMode = !editMode" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                        <span x-text="editMode ? t('cancel') : t('edit')"></span>
                    </button>
                </div>

                <div x-show="!editMode" class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700" x-text="t('base_url')"></label>
                        <p class="mt-1 text-sm text-gray-900" x-text="config.base_url"></p>
                    </div>
                    <div>
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700" x-text="t('token')"></label>
                            <button @click="validateToken()" :disabled="tokenValidating" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-xs disabled:bg-gray-400 disabled:cursor-not-allowed">
                                <span x-show="!tokenValidating" x-text="t('validate_token')"></span>
                                <span x-show="tokenValidating" x-text="t('validating')"></span>
                            </button>
                        </div>
                        <p class="mt-1 text-sm text-gray-900" x-text="config.token"></p>
                        <p x-show="tokenValidationMessage" x-text="tokenValidationMessage" class="mt-1 text-xs" :class="tokenValidationResult === 'success' ? 'text-green-600' : 'text-red-600'"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" x-text="t('batch_size')"></label>
                        <p class="mt-1 text-sm text-gray-900" x-text="config.batch_size"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" x-text="t('max_lines_per_blob')"></label>
                        <p class="mt-1 text-sm text-gray-900" x-text="config.max_lines_per_blob"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" x-text="t('text_extensions')"></label>
                        <p class="mt-1 text-sm text-gray-900" x-text="config.text_extensions?.join(', ')"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" x-text="t('exclude_patterns')"></label>
                        <p class="mt-1 text-sm text-gray-900" x-text="config.exclude_patterns?.join(', ')"></p>
                    </div>
                </div>

                <form x-show="editMode" @submit.prevent="saveConfig()" class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700" x-text="t('base_url')"></label>
                        <input type="text" x-model="editConfig.base_url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 border">
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-sm font-medium text-gray-700" x-text="t('token')"></label>
                            <button type="button" @click="validateToken(true)" :disabled="tokenValidating" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-xs disabled:bg-gray-400 disabled:cursor-not-allowed">
                                <span x-show="!tokenValidating" x-text="t('validate_token')"></span>
                                <span x-show="tokenValidating" x-text="t('validating')"></span>
                            </button>
                        </div>
                        <input type="text" x-model="editConfig.token" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 border">
                        <p x-show="tokenValidationMessage" x-text="tokenValidationMessage" class="mt-1 text-xs" :class="tokenValidationResult === 'success' ? 'text-green-600' : 'text-red-600'"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" x-text="t('batch_size')"></label>
                        <input type="number" x-model.number="editConfig.batch_size" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 border">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" x-text="t('max_lines_per_blob')"></label>
                        <input type="number" x-model.number="editConfig.max_lines_per_blob" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 border">
                        <p class="mt-1 text-xs text-gray-500" x-text="t('max_lines_per_blob_hint')"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" x-text="t('text_extensions')"></label>
                        <textarea x-model="editConfig.text_extensions_str" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 border" placeholder=".py, .js, .ts, .md"></textarea>
                        <p class="mt-1 text-xs text-gray-500" x-text="t('text_extensions_hint')"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" x-text="t('exclude_patterns')"></label>
                        <textarea x-model="editConfig.exclude_patterns_str" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 border" placeholder=".venv, node_modules, .git"></textarea>
                        <p class="mt-1 text-xs text-gray-500" x-text="t('exclude_patterns_hint')"></p>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm" x-text="t('save_changes')">
                        </button>
                        <button type="button" @click="editMode = false" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 text-sm" x-text="t('cancel')">
                        </button>
                    </div>
                    <p x-show="saveMessage" x-text="saveMessage" class="text-sm" :class="saveSuccess ? 'text-green-600' : 'text-red-600'"></p>
                </form>
            </div>

            <div class="bg-white shadow rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800" x-text="t('realtime_logs')"></h2>
                    <button @click="clearLogs()" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm" x-text="t('clear')">
                    </button>
                </div>
                <div class="bg-gray-900 text-green-400 p-4 rounded font-mono text-xs h-96 overflow-y-auto" id="log-container">
                    <template x-for="log in logs" :key="log.id">
                        <div x-text="log.text" class="mb-1"></div>
                    </template>
                    <template x-if="logs.length === 0">
                        <div class="text-gray-500" x-text="t('waiting_logs')"></div>
                    </template>
                </div>
                <div class="mt-2 text-sm text-gray-600">
                    <span :class="wsConnected ? 'text-green-600' : 'text-red-600'">
                        ● <span x-text="wsConnected ? t('connected') : t('disconnected')"></span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Tool Debugger Section -->
        <div class="mt-6 bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4" x-text="t('tool_debugger')"></h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Tool Selection and Input -->
                <div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('select_tool')"></label>
                        <select x-model="selectedTool" @change="updateToolForm()" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 border">
                            <option value="search_context" x-text="t('tool_search_context')"></option>
                        </select>
                    </div>

                    <form @submit.prevent="executeTool()" class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" x-text="t('project_root_path')"></label>
                            <input type="text" x-model="toolArgs.project_root_path" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 border" placeholder="C:/Users/username/projects/myproject" required>
                            <p class="mt-1 text-xs text-gray-500" x-text="t('project_root_path_hint')"></p>
                        </div>

                        <div x-show="selectedTool === 'search_context'">
                            <label class="block text-sm font-medium text-gray-700 mb-1" x-text="t('query')"></label>
                            <textarea x-model="toolArgs.query" rows="3" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 border" placeholder="查找所有调用 get_model 的地方"></textarea>
                            <p class="mt-1 text-xs text-gray-500" x-text="t('query_hint')"></p>
                        </div>

                        <div class="flex gap-2">
                            <button type="submit" :disabled="toolExecuting" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm disabled:bg-gray-400 disabled:cursor-not-allowed">
                                <span x-show="!toolExecuting" x-text="t('execute_tool')"></span>
                                <span x-show="toolExecuting" x-text="t('executing')"></span>
                            </button>
                            <button type="button" @click="clearToolResult()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 text-sm" x-text="t('clear')">
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Tool Result -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('tool_result')"></label>
                    <div class="bg-gray-900 text-green-400 p-4 rounded font-mono text-xs h-96 overflow-y-auto whitespace-pre-wrap" x-html="toolResult || '<span class=&quot;text-gray-500&quot;>' + t('no_result') + '</span>'">
                    </div>
                    <div x-show="toolError" class="mt-2 text-sm text-red-600" x-text="toolError"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const translations = {
            en: {
                title: 'Acemcp Management',
                subtitle: 'MCP Server for Codebase Indexing',
                status: 'Status',
                status_running: 'Running',
                status_loading: 'Loading',
                indexed_projects: 'Indexed Projects',
                storage_path: 'Storage Path',
                configuration: 'Configuration',
                edit: 'Edit',
                cancel: 'Cancel',
                base_url: 'Base URL',
                token: 'Token',
                batch_size: 'Batch Size',
                max_lines_per_blob: 'Max Lines Per Blob',
                max_lines_per_blob_hint: 'Maximum lines per blob before splitting (default: 800)',
                text_extensions: 'Text Extensions',
                text_extensions_hint: 'Comma-separated list of file extensions (e.g., .py, .js, .ts)',
                exclude_patterns: 'Exclude Patterns',
                exclude_patterns_hint: 'Comma-separated patterns to exclude (e.g., .venv, node_modules, *.pyc)',
                save_changes: 'Save Changes',
                realtime_logs: 'Real-time Logs',
                clear: 'Clear',
                waiting_logs: 'Waiting for logs...',
                connected: 'Connected',
                disconnected: 'Disconnected',
                tool_debugger: 'Tool Debugger',
                select_tool: 'Select Tool',
                tool_search_context: 'Search Context (Auto-indexes before search)',
                project_root_path: 'Project Root Path',
                project_root_path_hint: 'Use forward slashes (/) as path separators',
                query: 'Query',
                query_hint: 'Use descriptive keywords for semantic search. Example: "查找所有调用 get_model 的地方"',
                execute_tool: 'Execute Tool',
                executing: 'Executing...',
                tool_result: 'Tool Result',
                no_result: 'No result yet. Execute a tool to see the output.',
                validate_token: 'Validate Key',
                validating: 'Validating...',
                token_valid: 'Token is valid!',
                token_invalid: 'Token is invalid'
            },
            zh: {
                title: 'Acemcp 管理',
                subtitle: '代码库索引 MCP 服务器',
                status: '状态',
                status_running: '运行中',
                status_loading: '加载中',
                indexed_projects: '已索引项目',
                storage_path: '存储路径',
                configuration: '配置',
                edit: '编辑',
                cancel: '取消',
                base_url: '基础 URL',
                token: '令牌',
                batch_size: '批次大小',
                max_lines_per_blob: '每个 Blob 最大行数',
                max_lines_per_blob_hint: '文件拆分前的最大行数（默认：800）',
                text_extensions: '文本扩展名',
                text_extensions_hint: '逗号分隔的文件扩展名列表（例如：.py, .js, .ts）',
                exclude_patterns: '排除模式',
                exclude_patterns_hint: '逗号分隔的排除模式（例如：.venv, node_modules, *.pyc）',
                save_changes: '保存更改',
                realtime_logs: '实时日志',
                clear: '清空',
                waiting_logs: '等待日志...',
                connected: '已连接',
                disconnected: '已断开',
                tool_debugger: '工具调试器',
                select_tool: '选择工具',
                tool_search_context: '搜索上下文（搜索前自动索引）',
                project_root_path: '项目根路径',
                project_root_path_hint: '使用正斜杠 (/) 作为路径分隔符',
                query: '查询',
                query_hint: '使用描述性关键词进行语义搜索。示例："查找所有调用 get_model 的地方"',
                execute_tool: '执行工具',
                executing: '执行中...',
                tool_result: '工具结果',
                no_result: '暂无结果。执行工具以查看输出。',
                validate_token: '检测 Key',
                validating: '检测中...',
                token_valid: 'Token 有效！',
                token_invalid: 'Token 无效'
            }
        };

        function mcpManager() {
            return {
                lang: localStorage.getItem('lang') || 'en',
                status: {
                    status: 'loading',
                    project_count: 0,
                    storage_path: ''
                },
                config: {},
                editConfig: {},
                editMode: false,
                saveMessage: '',
                saveSuccess: false,
                logs: [],
                wsConnected: false,
                ws: null,
                logIdCounter: 0,
                wsReconnectAttempts: 0,
                wsMaxReconnectAttempts: 10,
                wsReconnectDelay: 1000, // Initial delay: 1 second
                wsReconnectTimer: null,
                wsManualClose: false,
                // Tool debugger state
                selectedTool: 'search_context',
                toolArgs: {
                    project_root_path: '',
                    query: ''
                },
                toolResult: '',
                toolError: '',
                toolExecuting: false,
                // Token validation state
                tokenValidating: false,
                tokenValidationResult: '',
                tokenValidationMessage: '',

                t(key) {
                    return translations[this.lang][key] || key;
                },

                setLanguage(lang) {
                    this.lang = lang;
                    localStorage.setItem('lang', lang);
                },

                async init() {
                    await this.loadStatus();
                    await this.loadConfig();
                    this.connectWebSocket();
                    setInterval(() => this.loadStatus(), 5000);
                },

                async loadStatus() {
                    try {
                        const response = await fetch('/api/status');
                        this.status = await response.json();
                    } catch (error) {
                        console.error('Failed to load status:', error);
                    }
                },

                async loadConfig() {
                    try {
                        const response = await fetch('/api/config');
                        this.config = await response.json();
                        this.editConfig = {
                            base_url: this.config.base_url,
                            token: this.config.token_full || '',
                            batch_size: this.config.batch_size,
                            max_lines_per_blob: this.config.max_lines_per_blob,
                            text_extensions_str: this.config.text_extensions?.join(', ') || '',
                            exclude_patterns_str: this.config.exclude_patterns?.join(', ') || ''
                        };
                    } catch (error) {
                        console.error('Failed to load config:', error);
                    }
                },

                async saveConfig() {
                    try {
                        this.saveMessage = 'Saving...';
                        this.saveSuccess = true;

                        const payload = {
                            base_url: this.editConfig.base_url,
                            token: this.editConfig.token,
                            batch_size: this.editConfig.batch_size,
                            max_lines_per_blob: this.editConfig.max_lines_per_blob,
                            text_extensions: this.editConfig.text_extensions_str
                                .split(',')
                                .map(ext => ext.trim())
                                .filter(ext => ext.length > 0),
                            exclude_patterns: this.editConfig.exclude_patterns_str
                                .split(',')
                                .map(pattern => pattern.trim())
                                .filter(pattern => pattern.length > 0)
                        };

                        const response = await fetch('/api/config', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            this.saveMessage = result.message;
                            this.saveSuccess = true;
                            await this.loadConfig();
                            await this.loadStatus();
                            setTimeout(() => {
                                this.editMode = false;
                                this.saveMessage = '';
                            }, 3000);
                        } else {
                            const error = await response.json();
                            this.saveMessage = error.detail || 'Failed to save configuration';
                            this.saveSuccess = false;
                        }
                    } catch (error) {
                        console.error('Failed to save config:', error);
                        this.saveMessage = 'Failed to save configuration: ' + error.message;
                        this.saveSuccess = false;
                    }
                },

                connectWebSocket() {
                    // Clear any pending reconnect timer
                    if (this.wsReconnectTimer) {
                        clearTimeout(this.wsReconnectTimer);
                        this.wsReconnectTimer = null;
                    }

                    // Close existing connection if any
                    if (this.ws && (this.ws.readyState === WebSocket.OPEN || this.ws.readyState === WebSocket.CONNECTING)) {
                        console.log('Closing existing WebSocket connection');
                        this.wsManualClose = true;
                        this.ws.close();
                    }

                    // Check if max reconnect attempts reached
                    if (this.wsReconnectAttempts >= this.wsMaxReconnectAttempts) {
                        console.warn('Max WebSocket reconnect attempts reached. Please refresh the page.');
                        return;
                    }

                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws/logs`;

                    this.ws = new WebSocket(wsUrl);

                    this.ws.onopen = () => {
                        this.wsConnected = true;
                        this.wsReconnectAttempts = 0; // Reset on successful connection
                        this.wsReconnectDelay = 1000; // Reset delay
                        this.wsManualClose = false;
                        console.log('WebSocket connected');
                    };

                    this.ws.onmessage = (event) => {
                        this.logs.push({
                            id: this.logIdCounter++,
                            text: event.data
                        });
                        if (this.logs.length > 500) {
                            this.logs.shift();
                        }
                        this.$nextTick(() => {
                            const container = document.getElementById('log-container');
                            if (container) {
                                container.scrollTop = container.scrollHeight;
                            }
                        });
                    };

                    this.ws.onclose = (event) => {
                        this.wsConnected = false;

                        // Don't reconnect if manually closed or normal closure
                        if (this.wsManualClose || event.code === 1000) {
                            console.log('WebSocket closed normally');
                            return;
                        }

                        // Increment reconnect attempts
                        this.wsReconnectAttempts++;

                        // Calculate exponential backoff delay (max 30 seconds)
                        const delay = Math.min(this.wsReconnectDelay * Math.pow(1.5, this.wsReconnectAttempts - 1), 30000);

                        console.log(`WebSocket disconnected (attempt ${this.wsReconnectAttempts}/${this.wsMaxReconnectAttempts}), reconnecting in ${delay}ms...`);

                        this.wsReconnectTimer = setTimeout(() => this.connectWebSocket(), delay);
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                    };
                },

                disconnectWebSocket() {
                    this.wsManualClose = true;
                    if (this.wsReconnectTimer) {
                        clearTimeout(this.wsReconnectTimer);
                        this.wsReconnectTimer = null;
                    }
                    if (this.ws) {
                        this.ws.close();
                        this.ws = null;
                    }
                    this.wsConnected = false;
                },

                clearLogs() {
                    this.logs = [];
                },

                updateToolForm() {
                    // Reset query when switching tools
                    if (this.selectedTool === 'index_code') {
                        this.toolArgs.query = '';
                    }
                },

                async executeTool() {
                    try {
                        this.toolExecuting = true;
                        this.toolError = '';
                        this.toolResult = '<span class="text-yellow-400">Executing...</span>';

                        const payload = {
                            tool_name: this.selectedTool,
                            arguments: {}
                        };

                        // Add project_root_path
                        if (this.toolArgs.project_root_path) {
                            payload.arguments.project_root_path = this.toolArgs.project_root_path;
                        }

                        // Add query for search_context
                        if (this.selectedTool === 'search_context' && this.toolArgs.query) {
                            payload.arguments.query = this.toolArgs.query;
                        }

                        const response = await fetch('/api/tools/execute', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();

                        if (result.status === 'success') {
                            // Format the result nicely
                            const formattedResult = JSON.stringify(result.result, null, 2);
                            this.toolResult = this.escapeHtml(formattedResult);
                        } else {
                            this.toolError = result.message || 'Unknown error';
                            this.toolResult = '<span class="text-red-400">Error: ' + this.escapeHtml(result.message || 'Unknown error') + '</span>';
                        }
                    } catch (error) {
                        console.error('Failed to execute tool:', error);
                        this.toolError = error.message;
                        this.toolResult = '<span class="text-red-400">Error: ' + this.escapeHtml(error.message) + '</span>';
                    } finally {
                        this.toolExecuting = false;
                    }
                },

                clearToolResult() {
                    this.toolResult = '';
                    this.toolError = '';
                },

                escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                },

                async validateToken(useEditConfig = false) {
                    try {
                        this.tokenValidating = true;
                        this.tokenValidationResult = '';
                        this.tokenValidationMessage = '';

                        const payload = {};

                        // Use edit config values if in edit mode, otherwise use current config
                        if (useEditConfig) {
                            if (this.editConfig.base_url) {
                                payload.base_url = this.editConfig.base_url;
                            }
                            if (this.editConfig.token) {
                                payload.token = this.editConfig.token;
                            }
                        }

                        const response = await fetch('/api/validate-token', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();

                        if (result.status === 'success') {
                            this.tokenValidationResult = 'success';
                            this.tokenValidationMessage = result.message;
                        } else {
                            this.tokenValidationResult = 'error';
                            this.tokenValidationMessage = result.message || 'Validation failed';
                        }
                    } catch (error) {
                        console.error('Failed to validate token:', error);
                        this.tokenValidationResult = 'error';
                        this.tokenValidationMessage = 'Failed to validate token: ' + error.message;
                    } finally {
                        this.tokenValidating = false;
                    }
                }
            };
        }
    </script>
</body>
</html>

